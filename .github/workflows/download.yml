name: Download

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  wait:
    runs-on: ubuntu-latest
    steps:
      - name: Wait
        run: sleep 20
  download-latest:
    runs-on: ubuntu-latest
    needs: wait
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Download
        uses: ./
        id: download-latest
        with:
          workflow: upload.yml
          name: artifact
          path: artifact
      - name: Test
        run: cat artifact/sha | grep $GITHUB_SHA
  download-branch:
    runs-on: ubuntu-latest
    needs: wait
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Download
        uses: ./
        with:
          workflow: upload.yml
          name: artifact
          path: artifact
          branch: master
      - name: Test
        run: cat artifact/sha | grep $GITHUB_SHA
  download-pr:
    runs-on: ubuntu-latest
    needs: wait
    if: github.ref != 'refs/heads/master'
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Download
        uses: ./
        with:
          workflow: upload.yml
          name: artifact
          path: artifact
          pr: ${{github.event.pull_request.number}}
      - name: Test
        run: cat artifact/sha | grep $GITHUB_SHA
  download-multiple:
    runs-on: ubuntu-latest
    needs: wait
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Download
        uses: ./
        with:
          workflow: upload.yml
      - name: Test
        run: |
          cat artifact1/sha1 | grep $GITHUB_SHA
          cat artifact2/sha2 | grep $GITHUB_SHA
  download-conclusion:
    runs-on: ubuntu-latest
    needs: wait
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Download
        uses: ./
        with:
          workflow: upload.yml
          name: artifact
          path: artifact
          workflow_conclusion: ''
      - name: Test
        run: cat artifact/sha | grep $GITHUB_SHA
  download-attempt-api-error:
    runs-on: ubuntu-latest
    needs: wait
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Download
        uses: ./
        id: download-latest
        continue-on-error: true
        with:
          testing: api_rate_limit_exceeded
          workflow: upload.yml
          name: artifact
          path: artifact
      
      - name: post-download-step-if-failed (should run)
        if: always() && steps.download-latest.outcome == 'failure'
        env:
          FAILURE_MESSAGE: ${{ steps.download-latest.outputs.error_message }}
        run: |
          echo "Post download step. Runs if there is an error"
          echo "Message = " $FAILURE_MESSAGE
      - name: step-for no artifacts found error (should NOT run)
        if: always() && contains(steps.download-latest.outputs.error_message, 'no artifacts found')
        run: |
          echo "The failure was specifically due to not finding artifacts"
      - name: step-for API rate limit exceeded for installation ID error (should run)
        if: always() && contains(steps.download-latest.outputs.error_message, 'API rate limit exceeded for installation ID')
        run: |
          echo "The failure was specifically due to exeeding API rate limits"
          exit 0;
      - name: post-download-step-if-not-failed (should not run)
        if: always() && steps.download-latest.outcome != 'failure'
        run: |
          echo "Post download step. Runs if there is NOT an error"
          exit 1;

      - name: Test (should not run)
        run: cat artifact/sha | grep $GITHUB_SHA
  download-attempt-no-artifacts-found:
    runs-on: ubuntu-latest
    needs: wait
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Download
        uses: ./
        id: download-latest
        with:
          testing: no_artifacts_found
          workflow: upload.yml
          name: artifact
          path: artifact
      
      - name: post-download-step-if-failed (should run)
        if: always() && steps.download-latest.outcome == 'failure'
        env:
          FAILURE_MESSAGE: ${{ steps.download-latest.outputs.error_message }}
        run: |
          echo "Post download step. Runs if there is an error"
          echo "Message = " $FAILURE_MESSAGE

      - name: step-for no artifacts found error (should run)
        if: always() && contains(steps.download-latest.outputs.error_message, 'no artifacts found')
        run: |
          echo "The failure was specifically due to not finding artifacts"

      - name: step-for API rate limit exceeded for installation ID error (should NOT run)
        if: always() && contains(steps.download-latest.outputs.error_message, 'API rate limit exceeded for installation ID')
        run: |
          echo "The failure was specifically due to exeeding API rate limits"

      - name: post-download-step-if-not-failed (should not run)
        if: always() && steps.download-latest.outcome != 'failure'
        run: |
          echo "Post download step. Runs if there is NOT an error"

      - name: Test (should not run)
        run: cat artifact/sha | grep $GITHUB_SHA